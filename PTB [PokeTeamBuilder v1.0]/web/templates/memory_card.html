{% extends "base.html" %}

{% block title %}PTB — Memory Card Manager{% endblock %}

{% block content %}
<div class="container">

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex align-items-center gap-3 mb-2">
                <i class="fas fa-sd-card fa-2x text-purple" style="filter: drop-shadow(0 0 8px var(--gc-purple-glow));"></i>
                <div>
                    <h2 class="mb-0">Memory Card Manager</h2>
                    <small class="text-muted" style="letter-spacing:0.1em;">
                        GAMECUBE SAVE DATA // .GCI &bull; .PTBMC
                    </small>
                </div>
            </div>
            <div class="alert alert-info mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Import <strong>.gci</strong> files from Pokemon Colosseum, XD: Gale of Darkness, or Pokemon Box.
                PTB saves cards in its own <strong>.ptbmc</strong> format (JSON-based, human-readable).
            </div>
        </div>
    </div>

    <div class="row g-4">

        <!-- Left: Card List + Actions -->
        <div class="col-lg-4">

            <!-- Upload GCI -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fas fa-upload me-2"></i>Import GCI File
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label class="form-label">Select .gci file</label>
                            <input type="file" class="form-control" id="gciFile" accept=".gci" required>
                            <div class="form-text text-muted" style="font-size:0.78rem;">
                                Colosseum (GC6E), XD (GXXE), Box (GPXE) — all regions
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-file-import me-2"></i>Import Save
                        </button>
                    </form>
                </div>
            </div>

            <!-- Create New Card -->
            <div class="card mb-3">
                <div class="card-header">
                    <i class="fas fa-plus-circle me-2"></i>New Virtual Card
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Card Label</label>
                        <input type="text" class="form-control" id="newCardLabel"
                               placeholder="Memory Card A" maxlength="32">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Size</label>
                        <select class="form-select" id="newCardSize">
                            <option value="59">59 Blocks (Standard)</option>
                            <option value="251">251 Blocks (1019 KB)</option>
                            <option value="1019">1019 Blocks (4 MB)</option>
                        </select>
                    </div>
                    <button class="btn btn-success w-100" onclick="createNewCard()">
                        <i class="fas fa-plus me-2"></i>Create Card
                    </button>
                </div>
            </div>

            <!-- Saved Cards List -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-list me-2"></i>Saved Cards
                    <span class="badge ms-2" style="background: var(--gc-purple);" id="cardCount">
                        {{ saved_cards|length }}
                    </span>
                </div>
                <div class="card-body p-0">
                    {% if saved_cards %}
                    <div class="list-group list-group-flush" id="cardList">
                        {% for card in saved_cards %}
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                             onclick="loadCard('{{ card.file }}')" style="cursor:pointer;">
                            <div>
                                <div style="font-family:'Orbitron',monospace; font-size:0.78rem; color: var(--gc-text-bright);">
                                    {{ card.label }}
                                </div>
                                <small class="text-muted">
                                    {{ card.slots }} slot{{ 's' if card.slots != 1 else '' }}
                                    &bull; {{ card.size_mb }} MB
                                </small>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); deleteCard('{{ card.file }}')"
                                    title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="p-3 text-center text-muted" style="font-size:0.85rem;">
                        <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                        No saved cards yet.<br>Import a .gci or create a new card.
                    </div>
                    {% endif %}
                </div>
            </div>

        </div>

        <!-- Right: Card Viewer -->
        <div class="col-lg-8">
            <div class="card" id="cardViewer">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-sd-card me-2"></i><span id="viewerTitle">No Card Loaded</span></span>
                    <div id="viewerActions" style="display:none;">
                        <button class="btn btn-sm btn-success me-2" onclick="saveCurrentCard()">
                            <i class="fas fa-save me-1"></i>Save
                        </button>
                        <button class="btn btn-sm btn-info" onclick="exportCard()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                </div>
                <div class="card-body" id="viewerBody">

                    <!-- Empty state -->
                    <div id="emptyState" class="text-center py-5">
                        <i class="fas fa-sd-card fa-4x mb-3" style="color: var(--gc-border);"></i>
                        <p class="text-muted">Import a .gci file or select a saved card to view its contents.</p>
                        <p class="text-muted" style="font-size:0.8rem; font-family:'Orbitron',monospace; letter-spacing:0.1em;">
                            AWAITING MEMORY CARD DATA
                        </p>
                    </div>

                    <!-- Card content (shown when loaded) -->
                    <div id="cardContent" style="display:none;">

                        <!-- Card info bar -->
                        <div class="gc-panel mb-4" id="cardInfoBar">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div style="font-family:'Orbitron',monospace; font-size:0.7rem; color:var(--gc-text-muted);">LABEL</div>
                                    <div id="infoLabel" class="text-cyan fw-bold" style="font-size:0.9rem;"></div>
                                </div>
                                <div class="col-3">
                                    <div style="font-family:'Orbitron',monospace; font-size:0.7rem; color:var(--gc-text-muted);">SLOTS</div>
                                    <div id="infoSlots" class="text-purple fw-bold" style="font-size:0.9rem;"></div>
                                </div>
                                <div class="col-3">
                                    <div style="font-family:'Orbitron',monospace; font-size:0.7rem; color:var(--gc-text-muted);">SIZE</div>
                                    <div id="infoSize" class="text-gold fw-bold" style="font-size:0.9rem;"></div>
                                </div>
                                <div class="col-3">
                                    <div style="font-family:'Orbitron',monospace; font-size:0.7rem; color:var(--gc-text-muted);">MODIFIED</div>
                                    <div id="infoModified" class="fw-bold" style="font-size:0.75rem; color:var(--gc-text);"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Slots -->
                        <div id="slotsContainer"></div>

                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Pokemon Detail Modal -->
<div class="modal fade" id="pokemonModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="pokemonModalTitle">Pokemon Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="pokemonModalBody"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="importToTeamBtn">
                    <i class="fas fa-users me-2"></i>Import to Team Builder
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentCard = null;

// ── Upload GCI ─────────────────────────────────────────────────────────────────
document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const file = document.getElementById('gciFile').files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('gci_file', file);

    try {
        const resp = await fetch('/api/memory-card/import-gci', {method:'POST', body: formData});
        const data = await resp.json();
        if (data.success) {
            showCard(data.card);
            showAlert('success', `Imported: ${data.card.card_label}`);
        } else {
            showAlert('danger', data.error || 'Import failed');
        }
    } catch(err) {
        showAlert('danger', 'Network error: ' + err.message);
    }
});

// ── Create New Card ────────────────────────────────────────────────────────────
async function createNewCard() {
    const label = document.getElementById('newCardLabel').value.trim() || 'Memory Card A';
    const size  = parseInt(document.getElementById('newCardSize').value);

    try {
        const resp = await fetch('/api/memory-card/create', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({label, size_mb: size})
        });
        const data = await resp.json();
        if (data.success) {
            showCard(data.card);
            showAlert('success', `Created: ${label}`);
            refreshCardList();
        } else {
            showAlert('danger', data.error || 'Create failed');
        }
    } catch(err) {
        showAlert('danger', 'Network error: ' + err.message);
    }
}

// ── Load Saved Card ────────────────────────────────────────────────────────────
async function loadCard(filePath) {
    try {
        const resp = await fetch('/api/memory-card/load', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({file_path: filePath})
        });
        const data = await resp.json();
        if (data.success) {
            showCard(data.card);
        } else {
            showAlert('danger', data.error || 'Load failed');
        }
    } catch(err) {
        showAlert('danger', 'Network error: ' + err.message);
    }
}

// ── Delete Card ────────────────────────────────────────────────────────────────
async function deleteCard(filePath) {
    if (!confirm('Delete this Memory Card? This cannot be undone.')) return;
    try {
        const resp = await fetch('/api/memory-card/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({file_path: filePath})
        });
        const data = await resp.json();
        if (data.success) {
            showAlert('success', 'Card deleted');
            refreshCardList();
        } else {
            showAlert('danger', data.error || 'Delete failed');
        }
    } catch(err) {
        showAlert('danger', 'Network error: ' + err.message);
    }
}

// ── Save Current Card ──────────────────────────────────────────────────────────
async function saveCurrentCard() {
    if (!currentCard) return;
    try {
        const resp = await fetch('/api/memory-card/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({card: currentCard})
        });
        const data = await resp.json();
        if (data.success) {
            showAlert('success', `Saved to ${data.file_path}`);
            refreshCardList();
        } else {
            showAlert('danger', data.error || 'Save failed');
        }
    } catch(err) {
        showAlert('danger', 'Network error: ' + err.message);
    }
}

// ── Export Card ────────────────────────────────────────────────────────────────
function exportCard() {
    if (!currentCard) return;
    const blob = new Blob([JSON.stringify(currentCard, null, 2)], {type: 'application/json'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = (currentCard.card_label || 'memory_card').replace(/\s+/g, '_') + '.ptbmc';
    a.click();
    URL.revokeObjectURL(url);
}

// ── Render Card ────────────────────────────────────────────────────────────────
function showCard(card) {
    currentCard = card;
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('cardContent').style.display = 'block';
    document.getElementById('viewerActions').style.display = 'flex';
    document.getElementById('viewerTitle').textContent = card.card_label || 'Memory Card';

    document.getElementById('infoLabel').textContent    = card.card_label || '—';
    document.getElementById('infoSlots').textContent    = (card.slots || []).length;
    document.getElementById('infoSize').textContent     = (card.card_size_mb || 59) + ' MB';
    document.getElementById('infoModified').textContent = card.modified_at
        ? new Date(card.modified_at).toLocaleDateString() : '—';

    renderSlots(card.slots || []);
}

function renderSlots(slots) {
    const container = document.getElementById('slotsContainer');
    if (!slots.length) {
        container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                No save slots on this card.
            </div>`;
        return;
    }

    const gameColors = {
        colosseum:   'var(--gc-purple)',
        xd_gale:     'var(--gc-cyan)',
        pokemon_box: 'var(--gc-gold)',
        unknown:     'var(--gc-text-muted)',
    };
    const gameLabels = {
        colosseum:   'Colosseum',
        xd_gale:     'XD: Gale of Darkness',
        pokemon_box: 'Pokemon Box',
        unknown:     'Unknown',
    };

    let html = '';
    slots.forEach((slot, i) => {
        const color = gameColors[slot.game] || 'var(--gc-text-muted)';
        const label = gameLabels[slot.game] || slot.game;
        const party = slot.party || [];
        const shadowCount = party.filter(p => p.is_shadow).length;

        html += `
        <div class="card mb-3" style="border-color: ${color}20;">
            <div class="card-header d-flex justify-content-between align-items-center"
                 style="border-bottom-color: ${color}40;">
                <div>
                    <span style="font-size:0.75rem; color:${color}; font-family:'Orbitron',monospace; letter-spacing:0.08em;">
                        SLOT ${slot.slot_index + 1} // ${label.toUpperCase()}
                    </span>
                    <span class="ms-2 text-muted" style="font-size:0.75rem;">
                        ${slot.trainer_name} &bull; ID: ${slot.trainer_id}
                        &bull; ${slot.play_time_h}h ${slot.play_time_m}m
                    </span>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    ${shadowCount > 0 ? `<span class="badge type-shadow">${shadowCount} Shadow</span>` : ''}
                    <span class="badge" style="background:var(--gc-surface-2); border:1px solid var(--gc-border); color:var(--gc-text-muted); font-size:0.62rem;">
                        ${party.length}/6 Pokemon
                    </span>
                </div>
            </div>
            <div class="card-body">
                ${party.length ? renderParty(party) : '<p class="text-muted mb-0" style="font-size:0.85rem;">Empty party</p>'}
            </div>
        </div>`;
    });

    container.innerHTML = html;
}

function renderParty(party) {
    let html = '<div class="row g-2">';
    party.forEach((p, i) => {
        const shadowClass = p.is_shadow ? 'shadow-aura' : '';
        const shadowBadge = p.is_shadow
            ? `<span class="badge type-shadow ms-1" style="font-size:0.55rem;">Shadow Lv.${p.shadow_level}</span>`
            : '';
        html += `
        <div class="col-md-4 col-sm-6">
            <div class="card ${shadowClass}" style="cursor:pointer; border-radius:6px;"
                 onclick="showPokemonDetail(${JSON.stringify(p).replace(/"/g, '"')})">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div style="font-family:'Orbitron',monospace; font-size:0.75rem; color:var(--gc-text-bright);">
                                ${p.nickname}${shadowBadge}
                            </div>
                            <small class="text-muted">${p.species_name} &bull; Lv.${p.level}</small>
                        </div>
                        <small class="text-muted">#${p.species_id}</small>
                    </div>
                    <div class="mt-1" style="font-size:0.72rem; color:var(--gc-text-muted);">
                        ${p.nature} &bull; ${p.moves.slice(0,2).join(', ') || 'No moves'}
                    </div>
                </div>
            </div>
        </div>`;
    });
    html += '</div>';
    return html;
}

// ── Pokemon Detail Modal ───────────────────────────────────────────────────────
function showPokemonDetail(pokemon) {
    document.getElementById('pokemonModalTitle').textContent =
        `${pokemon.nickname} (${pokemon.species_name})`;

    const shadowSection = pokemon.is_shadow ? `
        <div class="alert alert-warning mb-3">
            <i class="fas fa-ghost me-2"></i>
            <strong>Shadow Pokemon</strong> — Shadow Level ${pokemon.shadow_level}
            &bull; Purification: ${(pokemon.purification_progress * 100).toFixed(0)}%
        </div>` : '';

    const ivRow = (label, val) =>
        `<td style="font-size:0.8rem; padding:4px 8px;">${label}</td>
         <td style="font-size:0.8rem; padding:4px 8px; color:var(--gc-cyan);">${val}</td>`;

    document.getElementById('pokemonModalBody').innerHTML = `
        ${shadowSection}
        <div class="row g-3">
            <div class="col-md-6">
                <table class="table table-sm mb-0">
                    <tr><td class="text-muted" style="font-size:0.8rem;">Species</td>
                        <td style="font-size:0.8rem;">${pokemon.species_name} (#${pokemon.species_id})</td></tr>
                    <tr><td class="text-muted" style="font-size:0.8rem;">Level</td>
                        <td style="font-size:0.8rem;">${pokemon.level}</td></tr>
                    <tr><td class="text-muted" style="font-size:0.8rem;">Nature</td>
                        <td style="font-size:0.8rem;">${pokemon.nature}</td></tr>
                    <tr><td class="text-muted" style="font-size:0.8rem;">Gender</td>
                        <td style="font-size:0.8rem;">${pokemon.gender}</td></tr>
                    <tr><td class="text-muted" style="font-size:0.8rem;">OT</td>
                        <td style="font-size:0.8rem;">${pokemon.ot_name || '—'} (${pokemon.ot_id || '—'})</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <div style="font-family:'Orbitron',monospace; font-size:0.7rem; color:var(--gc-text-muted); margin-bottom:6px;">
                    INDIVIDUAL VALUES
                </div>
                <table class="table table-sm mb-0">
                    <tr>${ivRow('HP', pokemon.hp_iv)}${ivRow('Atk', pokemon.atk_iv)}</tr>
                    <tr>${ivRow('Def', pokemon.def_iv)}${ivRow('SpA', pokemon.spa_iv)}</tr>
                    <tr>${ivRow('SpD', pokemon.spd_iv)}${ivRow('Spe', pokemon.spe_iv)}</tr>
                </table>
            </div>
            <div class="col-12">
                <div style="font-family:'Orbitron',monospace; font-size:0.7rem; color:var(--gc-text-muted); margin-bottom:6px;">
                    MOVES
                </div>
                <div class="d-flex flex-wrap gap-2">
                    ${pokemon.moves.length
                        ? pokemon.moves.map(m => `<span class="badge" style="background:var(--gc-surface-2); border:1px solid var(--gc-border); color:var(--gc-text);">${m}</span>`).join('')
                        : '<span class="text-muted" style="font-size:0.85rem;">No moves recorded</span>'}
                </div>
            </div>
        </div>`;

    new bootstrap.Modal(document.getElementById('pokemonModal')).show();
}

// ── Utilities ──────────────────────────────────────────────────────────────────
function showAlert(type, message) {
    const div = document.createElement('div');
    div.className = `alert alert-${type} alert-dismissible fade show`;
    div.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.querySelector('.container').prepend(div);
    setTimeout(() => div.remove(), 5000);
}

async function refreshCardList() {
    try {
        const resp = await fetch('/api/memory-card/list');
        const data = await resp.json();
        const list = document.getElementById('cardList');
        document.getElementById('cardCount').textContent = data.cards.length;
        if (!list) return;
        list.innerHTML = data.cards.map(card => `
            <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
                 onclick="loadCard('${card.file.replace(/'/g, "\\'")}')" style="cursor:pointer;">
                <div>
                    <div style="font-family:'Orbitron',monospace; font-size:0.78rem; color:var(--gc-text-bright);">
                        ${card.label}
                    </div>
                    <small class="text-muted">${card.slots} slot${card.slots !== 1 ? 's' : ''} &bull; ${card.size_mb} MB</small>
                </div>
                <button class="btn btn-sm btn-danger"
                        onclick="event.stopPropagation(); deleteCard('${card.file.replace(/'/g, "\\'")}')"
                        title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>`).join('') || '<div class="p-3 text-center text-muted" style="font-size:0.85rem;"><i class="fas fa-inbox fa-2x mb-2 d-block"></i>No saved cards.</div>';
    } catch(err) {
        console.error('Refresh failed:', err);
    }
}
</script>
{% endblock %}
